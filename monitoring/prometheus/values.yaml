# ============================================================================
# Prometheus Helm Values - Custom Configuration
# ============================================================================
# Customizes the Prometheus Helm chart deployment on Minikube.
# ============================================================================

# Server configuration
server:
  persistentVolume:
    enabled: false  # Disable PV for Minikube (uses emptyDir)
  retention: "7d"
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

  # Global scrape config
  global:
    scrape_interval: 15s
    evaluation_interval: 15s

# AlertManager configuration
alertmanager:
  enabled: true
  persistentVolume:
    enabled: false
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 100m
      memory: 128Mi

# Pushgateway (disabled for this project)
pushgateway:
  enabled: false

# Node exporter
nodeExporter:
  enabled: true
  resources:
    requests:
      cpu: 50m
      memory: 32Mi
    limits:
      cpu: 100m
      memory: 64Mi

# kube-state-metrics
kubeStateMetrics:
  enabled: true

# Extra scrape configs for our application
extraScrapeConfigs: |
  - job_name: 'task-manager-api'
    kubernetes_sd_configs:
      - role: pod
        namespaces:
          names:
            - task-manager
    relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
        action: replace
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: $1:$2
        target_label: __address__
      - source_labels: [__meta_kubernetes_namespace]
        action: replace
        target_label: kubernetes_namespace
      - source_labels: [__meta_kubernetes_pod_name]
        action: replace
        target_label: kubernetes_pod_name

# Alert rules
serverFiles:
  alerting_rules.yml:
    groups:
      - name: task-manager-alerts
        rules:
          # High error rate alert
          - alert: HighErrorRate
            expr: |
              sum(rate(taskmanager_http_requests_total{status_code=~"5.."}[5m]))
              /
              sum(rate(taskmanager_http_requests_total[5m]))
              > 0.05
            for: 2m
            labels:
              severity: critical
            annotations:
              summary: "High error rate detected"
              description: "Error rate is above 5% for the last 2 minutes"

          # High latency alert
          - alert: HighLatency
            expr: |
              histogram_quantile(0.95,
                sum(rate(taskmanager_http_request_duration_seconds_bucket[5m])) by (le)
              ) > 0.5
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High latency detected"
              description: "P95 latency is above 500ms for the last 5 minutes"

          # Pod crash loop alert
          - alert: PodCrashLooping
            expr: |
              rate(kube_pod_container_status_restarts_total{
                namespace="task-manager"
              }[15m]) > 0
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: "Pod crash looping"
              description: "Pod {{ $labels.pod }} is crash looping"

          # High CPU usage alert
          - alert: HighCPUUsage
            expr: |
              sum(rate(container_cpu_usage_seconds_total{
                namespace="task-manager"
              }[5m])) by (pod)
              /
              sum(kube_pod_container_resource_limits{
                namespace="task-manager",
                resource="cpu"
              }) by (pod)
              > 0.8
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High CPU usage"
              description: "Pod {{ $labels.pod }} CPU usage is above 80%"
